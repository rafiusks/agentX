<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Persistence Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #0a0a0a;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .error {
            color: #ff5555;
        }
        .success {
            color: #50fa7b;
        }
        pre {
            background: #282a36;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #444;
            background: #282a36;
            color: white;
        }
    </style>
</head>
<body>
    <h1>Chat Persistence Test</h1>
    
    <div class="section">
        <h2>1. Set Authentication Token</h2>
        <p>Paste the JWT token here:</p>
        <textarea id="token" rows="4">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InZpZGFsQGxpdmUuY29tIiwiZXhwIjoxNzU0NjE5Mzk1LCJpYXQiOjE3NTQ1MzI5OTUsImlzcyI6ImFnZW50eCIsInJvbGUiOiJ1c2VyIiwic2Vzc2lvbl9pZCI6IjA4MGYzZDdlLTE4NTctNDk3ZC05ZDBiLWMzZDM0ZTJmNWZhNyIsInRva2VuX3R5cGUiOiJhY2Nlc3MiLCJ1c2VyX2lkIjoiMjE2MmVmNmUtYzAwYS00ZDc1LTlmNmMtODBkMmRjNzU5YTA3IiwidXNlcm5hbWUiOiJ2aWRhbCJ9.qkMqWeIysNC8e1WsSdkbRsONv914wEiCsdmEemBv0mY</textarea>
        <button onclick="setToken()">Set Token in localStorage</button>
        <div id="tokenStatus"></div>
    </div>

    <div class="section">
        <h2>2. Test Session Creation</h2>
        <input type="text" id="sessionTitle" placeholder="Session Title" value="Test Chat Session">
        <button onclick="createSession()">Create Session</button>
        <div id="sessionResult"></div>
    </div>

    <div class="section">
        <h2>3. List Sessions</h2>
        <button onclick="listSessions()">List All Sessions</button>
        <div id="sessionsList"></div>
    </div>

    <div class="section">
        <h2>4. Send Message to Session</h2>
        <input type="text" id="sessionId" placeholder="Session ID">
        <textarea id="messageContent" rows="3" placeholder="Message content">Hello, this is a test message!</textarea>
        <button onclick="sendMessage()">Send Message</button>
        <div id="messageResult"></div>
    </div>

    <div class="section">
        <h2>5. Get Session Messages</h2>
        <input type="text" id="sessionIdMessages" placeholder="Session ID">
        <button onclick="getMessages()">Get Messages</button>
        <div id="messagesList"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api/v1';
        
        function setToken() {
            const token = document.getElementById('token').value.trim();
            localStorage.setItem('access_token', token);
            document.getElementById('tokenStatus').innerHTML = '<p class="success">Token saved to localStorage!</p>';
        }

        async function makeRequest(endpoint, method = 'GET', body = null) {
            const token = localStorage.getItem('access_token');
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                return { success: true, data };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function createSession() {
            const title = document.getElementById('sessionTitle').value;
            const result = await makeRequest('/sessions', 'POST', { title });
            
            const resultDiv = document.getElementById('sessionResult');
            if (result.success) {
                const sessionId = result.data.ID || result.data.id;
                resultDiv.innerHTML = `
                    <p class="success">Session created successfully!</p>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    <p>Session ID: <strong>${sessionId}</strong></p>
                `;
                // Auto-fill session ID fields
                document.getElementById('sessionId').value = sessionId;
                document.getElementById('sessionIdMessages').value = sessionId;
            } else {
                resultDiv.innerHTML = `<p class="error">Error: ${result.error}</p>`;
            }
        }

        async function listSessions() {
            const result = await makeRequest('/sessions');
            
            const listDiv = document.getElementById('sessionsList');
            if (result.success) {
                const sessions = result.data.sessions || [];
                listDiv.innerHTML = `
                    <p class="success">Found ${sessions.length} sessions</p>
                    <pre>${JSON.stringify(sessions, null, 2)}</pre>
                `;
            } else {
                listDiv.innerHTML = `<p class="error">Error: ${result.error}</p>`;
            }
        }

        async function sendMessage() {
            const sessionId = document.getElementById('sessionId').value;
            const content = document.getElementById('messageContent').value;
            
            const result = await makeRequest(`/sessions/${sessionId}/messages`, 'POST', {
                content,
                connection_id: 'test-connection'
            });
            
            const resultDiv = document.getElementById('messageResult');
            if (result.success) {
                resultDiv.innerHTML = `
                    <p class="success">Message sent successfully!</p>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre>
                `;
            } else {
                resultDiv.innerHTML = `<p class="error">Error: ${result.error}</p>`;
            }
        }

        async function getMessages() {
            const sessionId = document.getElementById('sessionIdMessages').value;
            const result = await makeRequest(`/sessions/${sessionId}/messages`);
            
            const listDiv = document.getElementById('messagesList');
            if (result.success) {
                const messages = result.data.messages || [];
                listDiv.innerHTML = `
                    <p class="success">Found ${messages.length} messages</p>
                    <pre>${JSON.stringify(messages, null, 2)}</pre>
                `;
            } else {
                listDiv.innerHTML = `<p class="error">Error: ${result.error}</p>`;
            }
        }
        
        // Set token on load
        window.onload = () => {
            const token = localStorage.getItem('access_token');
            if (token) {
                document.getElementById('token').value = token;
                document.getElementById('tokenStatus').innerHTML = '<p class="success">Token loaded from localStorage</p>';
            }
        };
    </script>
</body>
</html>